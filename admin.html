<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel â€” Mudofaa Vazirligi</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>





body{
  font-family:'Roboto',Arial,sans-serif;
  background:#0c1a27;
  color:white;
  margin:0;
  padding:20px;
}
header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:20px;
}
header img{
  width:60px;
  height:60px;
  border-radius:50%;
  object-fit:cover;
}
header h1{
  font-size:22px;
  font-weight:700;
  color:#1a73e8;
}
input[type="text"]{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  margin-bottom:10px;
  width:100%;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#1a2a4b;
  border-radius:8px;
  overflow:hidden;
  margin-top:10px;
}
th,td{
  padding:12px;
  border:1px solid #1a73e8;
  text-align:left;
  vertical-align:top;
}
th{
  background:#1a73e8;
  color:white;
  position: sticky;
  top:0;
}
.viewBtn, .deleteBtn{
  background:#1a73e8;
  color:white;
  padding:4px 8px;
  border-radius:4px;
  cursor:pointer;
  font-size:13px;
  margin-right:4px;
}
.viewBtn:hover{ background:#155ab6; }
.deleteBtn{ background:#d33; }
.deleteBtn:hover{ background:#a00; }
.modal{
  display:none;
  position:fixed;
  z-index:1000;
  left:0;top:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
}
.modalContent{
  background:white;
  color:black;
  padding:20px;
  border-radius:12px;
  width:80%;
  max-height:80%;
  overflow-y:auto;
}
.closeBtn{
  background:#d33;
  color:white;
  border:none;
  padding:4px 8px;
  cursor:pointer;
  border-radius:4px;
  float:right;
}
</style>
</head>
<body>













<header>
  <img src="rasm/mho_logoo.jfif" alt="Logo">
  <h1>Mudofaa Vazirligi â€” Admin Panel</h1>
</header>

<input type="text" id="searchInput" placeholder="Ism, Familiya, Login yoki Viloyat boâ€˜yicha qidirish..." onkeyup="searchUser()">









<button onclick="openMessages()" style="
  padding:8px 14px;
  background:#1a73e8;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-bottom:15px;
">
  ðŸ“© Adminga kelgan xabarlar
</button>

<button onclick="generatePDF()" style="margin-top:10px; padding:6px 12px; background:#1a73e8; color:white; border:none; border-radius:6px; cursor:pointer;">
  Tanlangan bo'lim PDF
</button>










<div class="modal" id="msgModal" style="
  display:none;position:fixed;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.7);z-index:2000;
  justify-content:center;align-items:center;
">
  <div class="modalContent" style="max-width:600px;">
    <button class="closeBtn" onclick="closeMsgModal()">X</button>
    <h2>ðŸ“¨ Foydalanuvchi xabarlari</h2>
    <div id="msgList"></div>
  </div>
</div>
<div class="modal" id="replyModal" style="
  display:none;position:fixed;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.7);z-index:2100;
  justify-content:center;align-items:center;
">
  <div class="modalContent" style="max-width:450px;">
    <button class="closeBtn" onclick="closeReply()">X</button>
    <h3>Javob yozish</h3>
    <textarea id="replyText" style="width:100%;height:120px;padding:8px;margin-top:10px;"></textarea>
    <button onclick="sendReply()" style="background:green;color:white;width:100%;margin-top:10px;padding:10px;border:none;border-radius:6px;cursor:pointer;">
      Yuborish
    </button>
  </div>
</div>




<script>
// Xabarlar
let adminMsgs = JSON.parse(localStorage.getItem("adminMessages") || "[]");
let activeIndex = null;

// Xabarlar oynasini ochish
function openMessages(){
  loadMessages();
  document.getElementById("msgModal").style.display = "flex";
}

// Yopish
function closeMsgModal(){
  document.getElementById("msgModal").style.display = "none";
}

// Xabarlarni yuklash
function loadMessages(){
  adminMsgs = JSON.parse(localStorage.getItem("adminMessages") || "[]");
  let list = document.getElementById("msgList");
  list.innerHTML = "";

  if(adminMsgs.length === 0){
    list.innerHTML = "<p>Hozircha xabar yo'q</p>";
    return;
  }

  adminMsgs.forEach((m, i)=>{
    list.innerHTML += `
      <div style="background:${m.read ? '#e8ffe8' : '#ffe8e8'};padding:12px;border-radius:8px;margin-bottom:10px;">
        <strong>${m.name}</strong> <small>(${m.time})</small><br>
        <p>${m.message}</p>

        ${m.reply ? `<p><strong>Admin javobi:</strong><br>${m.reply}</p>` : ""}

        <button onclick="markRead(${i})" style="
          background:#1a73e8;color:white;padding:5px 10px;border:none;border-radius:4px;cursor:pointer;
        ">${m.read ? "Oâ€˜qilgan" : "Oâ€˜qilgan deb belgilash"}</button>

        <button onclick="openReplyBox(${i})" style="
          background:green;color:white;padding:5px 10px;border:none;border-radius:4px;cursor:pointer;
        ">Javob yozish</button>

        <button onclick="deleteMsg(${i})" style="
          background:#d33;color:white;padding:5px 10px;border:none;border-radius:4px;cursor:pointer;
        ">Oâ€˜chirish</button>
      </div>
    `;
  });
}

// Oâ€˜qilgan deb belgilash
function markRead(i){
  adminMsgs[i].read = true;
  localStorage.setItem("adminMessages", JSON.stringify(adminMsgs));
  loadMessages();
}

// Xabar oâ€˜chirish
function deleteMsg(i){
  if(confirm("Xabar oâ€˜chirilsinmi?")){
    adminMsgs.splice(i, 1);
    localStorage.setItem("adminMessages", JSON.stringify(adminMsgs));
    loadMessages();
  }
}

// Javob oynasini ochish
function openReplyBox(i){
  activeIndex = i;
  document.getElementById("replyModal").style.display = "flex";
}

// Javob modal yopish
function closeReply(){
  document.getElementById("replyModal").style.display = "none";
}

// Javob yuborish
function sendReply(){
  let text = document.getElementById("replyText").value.trim();
  if(!text) return alert("Javob yozing!");

  adminMsgs[activeIndex].reply = text;
  adminMsgs[activeIndex].read = true;

  localStorage.setItem("adminMessages", JSON.stringify(adminMsgs));
  document.getElementById("replyText").value = "";
  document.getElementById("replyModal").style.display = "none";
  loadMessages();
}
</script>






<table>
<thead>
<tr>
  <th>Ism</th>
  <th>Familiya</th>
  <th>Viloyat</th>
  <th>Login</th>
  <th>Parol</th>
  <th>Sotsiologik</th>
  <th>Ruhiy</th>
  <th>Harbiy</th>
  <th>IQ</th>
  <th>Tahrirlash</th>
</tr>
</thead>
<tbody id="users"></tbody>
</table>

<div class="modal" id="modal">
  <div class="modalContent">
    <button class="closeBtn" onclick="closeModal()">X</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>



// F12 va boshqa DevTools larni bloklash
document.onkeydown = function(e){
  if(e.key === "F12"){
    return false;
  }
  if(e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C")){
    return false;
  }
  if(e.ctrlKey && e.key === "U"){
    return false;
  }
};

// O'ng tugmani bloklash
document.addEventListener("contextmenu", e => e.preventDefault());

// DevTools ochilganini aniqlash (yanada kuchaytirilgan himoya)
setInterval(() => {
  const start = performance.now();
  debugger;
  const end = performance.now();
  if(end - start > 100){
    alert("Developer Tools taqiqlangan!");
    location.reload();
  }
}, 500);




// Admin tekshiruv
if(localStorage.getItem("current_user") !== "ADMIN"){
  alert("Admin emassiz!");
  window.location.href = "kirish.html";
}

let allUsers = JSON.parse(localStorage.getItem("all_users") || "[]");
let results = JSON.parse(localStorage.getItem("results") || "[]");
const box = document.getElementById("users");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");

// Modalni koâ€˜rsatish
function showAnswers(testType, login){
  const userResults = results.filter(r=>r.login===login && r.test===testType);
  modalBody.innerHTML = `<h3>${testType} Test Javoblari</h3><hr>`;
  if(userResults.length===0){
    modalBody.innerHTML += "Test topshirmagan";
  } else {
    userResults.forEach(r=>{
      if(r.answers && r.answers.length>0){
        r.answers.forEach((a,i)=>{
          modalBody.innerHTML += `${i+1}. ${a}<br>`;
        });
      } else {
        modalBody.innerHTML += "Test topshirmagan<br>";
      }
      modalBody.innerHTML += "<hr>";
    });
  }
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

// Foydalanuvchi oâ€˜chirish
function deleteUser(login){
  if(confirm(`Foydalanuvchi ${login} ni oâ€˜chirilsinmi?`)){
    allUsers = allUsers.filter(u=>u.login!==login);
    localStorage.setItem("all_users", JSON.stringify(allUsers));
    results = results.filter(r=>r.login!==login);
    localStorage.setItem("results", JSON.stringify(results));
    adminPasswords = JSON.parse(localStorage.getItem("admin_passwords")||"[]").filter(p=>p.login!==login);
    localStorage.setItem("admin_passwords", JSON.stringify(adminPasswords));
    renderTable(allUsers);
  }
}

// Jadvalni yaratish
function renderTable(users){
  box.innerHTML = "";
  users.forEach(u=>{
    box.innerHTML += `
    <tr>
      <td>${u.ism}</td>
      <td>${u.fam}</td>
      <td>${u.vil}</td>
      <td>${u.login}</td>
      <td>${u.pass || ''}</td>
      <td><button class="viewBtn" onclick='showAnswers("Sotsiologik","${u.login}")'>Ko'rish</button></td>
      <td><button class="viewBtn" onclick='showAnswers("Ruhiy","${u.login}")'>Ko'rish</button></td>
      <td><button class="viewBtn" onclick='showAnswers("Harbiy","${u.login}")'>Ko'rish</button></td>
      <td><button class="viewBtn" onclick='showAnswers("IQ","${u.login}")'>Ko'rish</button></td>
      <td><button class="deleteBtn" onclick='deleteUser("${u.login}")'>Oâ€˜chirish</button></td>
    </tr>`;
  });
}
renderTable(allUsers);

// Qidiruv â€” kengaytirilgan
function searchUser(){
  let input = document.getElementById("searchInput").value.toLowerCase();
  let filtered = allUsers.filter(u=>{
    return u.ism.toLowerCase().includes(input) || 
           u.fam.toLowerCase().includes(input) || 
           u.login.toLowerCase().includes(input) ||
           (u.vil && u.vil.toLowerCase().includes(input));
  });
  renderTable(filtered);
}
</script>











<!-- jsPDF va autoTable kutubxonalarini headga qo'shish -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<!-- PDF tugmasini qidiruv qatoriga qo'shamiz -->

<script>
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Bo'lim tanlash
  const testType = prompt("Qaysi boâ€˜lim test natijalarini PDF ga chiqaramiz? (Sotsiologik, Ruhiy, Harbiy, IQ)");
  if(!["Sotsiologik","Ruhiy","Harbiy","IQ"].includes(testType)){
    alert("Iltimos toâ€˜gâ€˜ri boâ€˜lim tanlang!");
    return;
  }

  // PDF sarlavhasi
  doc.setFontSize(16);
  doc.setTextColor(26, 115, 232);
  doc.text(`Mudofaa Vazirligi â€” ${testType} Test Natijalari`, 14, 20);

  // Jadval ma'lumotlari
  const tableData = allUsers.map(u=>{
    const userResults = results.filter(r=>r.login===u.login && r.test===testType);
    let answers = [];
    if(userResults.length>0 && userResults[0].answers && userResults[0].answers.length>0){
      answers = userResults[0].answers;
    }

    // 14 ta javobni 3 qator: 5+5+4
    let formatted = '';
    for(let i=0;i<answers.length;i+=5){
      formatted += answers.slice(i,i+5).join(' , ') + '\n';
    }

    if(formatted==='') formatted = 'YOQ'; // test topshirmagan

    return [u.fam, u.ism, formatted];
  });

  // autoTable yordamida jadval yaratish
doc.autoTable({
  startY: 30,
  head: [['FAMILIYA','ISM','TEST NATIJASI']],
  body: tableData,
  styles: {
    font: 'helvetica',    // professional shrift
    fontSize: 10,
    cellPadding: 4,
    lineColor: [0,0,0],   // qora ramka
    lineWidth: 0.5,
    textColor: [0,0,0],   // qora matn
    halign: 'center',     // barcha so'zlar markazda
    valign: 'middle'
  },
  headStyles: {
    fillColor: [255,255,255], // sarlavha fon oq
    textColor: [0,0,0],       // qora matn
    halign: 'center',
    fontStyle: 'bold'
  },
  columnStyles: {
    2: {halign:'left', cellWidth: 120} // Test javoblari chapga, boshqa qatorlar markazda
  }
});

  // PDF saqlash
  doc.save(`${testType}_test_natijalari.pdf`);
}
</script>




</body>
</html>
